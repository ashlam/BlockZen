# 道具模式玩法说明

## 模式概述
- 道具模式在经典玩法基础上加入“道具与金币经济”。玩家可以使用或购买道具来改变当前托盘中的零件，从而创造更好的放置与消除机会。
- 使用界面保持一致：棋盘区 + 托盘区 + 道具区 + 取消区。可通过配置决定是否显示某区域。

## UI与交互
- 道具栏（底部）：显示三种道具的“名称/图标”“库存数量”“本次使用价格”。当库存数量大于 0 时，价格仍显示但仅用于提示。
- 取消区：相对移动模式下，拖拽时在取消区松手视为取消放置。
- 弹窗交互：旋转与骰子在使用时会弹出带预览的操作弹窗，支持确认。

## 道具种类
1. 旋转
   - 图标：风车形
   - 效果：选择托盘内一个零件后进入弹窗，点击“旋转”可使其方向顺时针旋转 90°，可多次；点击“确认”后该零件变为最终形状。
2. 骰子
   - 图标：骰子形
   - 效果：选择托盘内一个零件后进入弹窗，弹窗左侧显示原零件，右侧显示一个随机新零件；点击任一侧选中，再点击“确认”最终替换。
3. 换牌
   - 图标：弃牌框
   - 效果：弹窗确认后将当前托盘的三个零件全部丢弃并重新生成新的三枚零件；取消不变更但该次视为使用过（若采用“购买一次并使用”的流程则不扣库存）。

## 使用规则
- 使用优先级：若该道具库存数量（count）大于 0，则直接使用并扣减 1；否则需用金币按“本次使用价格”购买一次并使用。
- 价格随使用次数递增：对于某种道具的使用次数 `usage`，价格为 `ITEM_COST_CFG[type][min(usage, lastIndex)]`。
- 金币不足提示：当金币小于本次价格时，会弹窗提示“金币不足：需要 X 金币，当前 Y 金币”。

## 经济与奖励
- 经济配置：见 `miniprogram/config/item_price.js`：
  - `COIN_CFG.scorePerCoin`：分数到金币的分桶换算
  - `COIN_CFG.stepComboCoinMap`：步内连击（单步同时清除的行/列/3x3 总数）对应金币奖励
  - `COIN_CFG.consecutiveComboCoinMap`：跨步连续连击 T 对应金币奖励（在回合结束时结算）
  - `ITEM_COST_CFG`：各道具随使用次数递增的阶梯价格
  - `ITEM_BUY_CFG`：商店购买该道具的固定价格（可用于库存补充）
  - `ITEM_START_COUNT`：道具模式开局赠送的库存数量
- 金币获得时机：
  - 落子即时：分数达到新的分桶（`scorePerCoin` 的整数倍）时 +金币
  - 步内连击：单步清除区域数 ≥ 3 时按 `stepComboCoinMap` +金币
  - 回合连击：托盘清空后按连续连击 T 在 `finalizeTurn` 中按 `consecutiveComboCoinMap[T]` +金币

## 失败判定与刷新
- 托盘空且无解：回合结束刷新后仍不可放置，触发失败。
- 托盘未空但无解：放置后若没有产生清除，立即检查是否无解；若本步有清除，延迟等待清除动画后检查。

## 配置入口
- 文件：`miniprogram/config/item_price.js`
  - 字段注释已写明用途
  - 可直接调整价格、奖励与开局库存
- 代码读取：
  - 价格与奖励读取在 `src/logic/GameManager.js` 与 `src/input/InputHandler.js` 的相关逻辑中

## 设计建议
- 价格阶梯长度与斜率：旋转与骰子建议递增较缓，换牌建议更保守，以避免频繁刷新托盘导致策略性下降。
- 奖励分配：低连击奖励适度，鼓励玩家追求更高 T 连击。

